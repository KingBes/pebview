name: Build

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # 允许手动触发

jobs:

  build-macos-arm64:
    runs-on: macos-latest
    name: Build for macOS arm64
    env:
      # 设置环境变量以确保脚本正确识别构建环境
      BUILD_ARCH: arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build project for arm64
      run: |
        # 确保脚本有执行权限
        chmod +x ./source/macos.sh
        # 执行构建脚本
        ./source/macos.sh

    - name: Upload artifact for arm64
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64
        path: ./lib/macos/arm64/PebView.dylib
        if-no-files-found: error
  
  build-windows-x86_64:
    runs-on: windows-2022
    name: Build for Windows x86_64
    env:
      # 设置环境变量以确保脚本正确识别构建环境
      BUILD_ARCH: x86_64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up build environment
      run: |
        # 使用 Chocolatey 安装 MinGW
        choco install -y mingw
        # 将 MinGW 添加到 PATH
        $env:PATH += ";C:\ProgramData\mingw64\mingw64\bin"
        # 保存 PATH 以便后续步骤使用
        echo "C:\ProgramData\mingw64\mingw64\bin" >> $env:GITHUB_PATH

    - name: Build project for x86_64
      run: |
        # 执行构建脚本
        ./source/build.cmd

    - name: Upload artifact for x86_64
      uses: actions/upload-artifact@v4
      with:
        name: windows-x86_64
        path: ./lib/windows/PebView.dll
        if-no-files-found: error
  
  build-linux-x86_64:
    runs-on: ubuntu-latest
    name: Build for Linux x86_64
    env:
      # 设置环境变量以确保脚本正确识别构建环境
      BUILD_ARCH: x86_64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential pkg-config
        sudo apt-get install libgtk-3-dev libwebkit2gtk-4.1-dev

    - name: Build project for x86_64
      run: |
        # 确保脚本有执行权限
        chmod +x ./source/linux.sh
        # 执行构建脚本
        ./source/linux.sh

    - name: Upload artifact for x86_64
      uses: actions/upload-artifact@v4
      with:
        name: linux-x86_64
        path: ./lib/linux/x86_64/PebView.so
        if-no-files-found: error
  
  build-linux-aarch64:
    runs-on: ubuntu-latest
    name: Build for Linux aarch64
    env:
      # 设置环境变量以确保脚本正确识别构建环境
      BUILD_ARCH: aarch64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up build environment for cross-compilation
      run: |
        sudo apt-get update
        # 启用 arm64 架构支持
        sudo dpkg --add-architecture arm64
        sudo apt-get update
        # 安装交叉编译工具链
        sudo apt-get install -y build-essential pkg-config crossbuild-essential-arm64
        # 安装 aarch64 版本的依赖库
        sudo apt-get install -y libgtk-3-dev:arm64
        # 尝试安装 webkit2gtk 依赖，使用不同的包名
        sudo apt-get install -y libwebkit2gtk-4.0-dev:arm64 || true
        # 安装其他必要的 aarch64 库
        sudo apt-get install -y libglib2.0-dev:arm64 libcairo2-dev:arm64 libpango1.0-dev:arm64
        # 安装 pkg-config 交叉编译支持
        sudo apt-get install -y pkg-config-arm64-linux-gnu

    - name: Build project for aarch64
      run: |
        # 确保脚本有执行权限
        chmod +x ./source/linux.sh
        # 设置交叉编译环境变量
        export CC=aarch64-linux-gnu-gcc
        export CXX=aarch64-linux-gnu-g++
        export PKG_CONFIG=aarch64-linux-gnu-pkg-config
        export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
        # 执行构建脚本
        ./source/linux.sh

    - name: Upload artifact for aarch64
      uses: actions/upload-artifact@v4
      with:
        name: linux-aarch64
        path: ./lib/linux/aarch64/PebView.so
        if-no-files-found: error